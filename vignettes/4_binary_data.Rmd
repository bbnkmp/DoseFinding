
---
title: "Design and analysis template MCP-Mod for binary data"
output: rmarkdown::html_vignette
bibliography: refs.bib
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, cache = TRUE)
```

Illustrate points to consider for binary data for planning and
analysis stage (See pitfalls pdf document)
- Use of generalized MCP-Mod
- For planning: Contrasts depend on variance. Variance itself is
  determined by the response probabilities. Variance estimation may be
  poor for limited data -> May consider assuming fixed (pooled)
  variance estimate by default (then actually no need for variance
  estimation).
- May utilize Firth regression as first stage fit (in case there is a
  risk of low number of responders)
- Estimation of response probabilities based on a model that was
  fitted to the logit with covariates.

## Background

Utilize fake example (motivated by QGE in atopic dermatitis):
Ideally with covariate adjustment.

Use doses 0, 0.5, 1.5, 2.5, 4 with assumed response rates 10%, ranging
up to 45% with 30 patients per group.

## Candidate set

```{r}
library(DoseFinding)
doses <- c(0, 0.5, 1.5, 2.5, 4)
## define candidate models (as used in NVA study)
mods <- Mods(emax = c(0.25, 1), 
             sigEmax = rbind(c(1, 3), c(2.5, 4)),
             betaMod = c(1.1, 1.1),
             placEff = 1.25, maxEff = 0.15,
         doses = doses)
## graphical display of candidate shapes
plot(mods)
```

## Sample size considerations

Show how to perform sample size calculations for power considerations.
Show formula for variance on logit scale. Refer to discussion on
nuisance parameter (no problem for Gaussian data, but problem for
binary, refer to simulations later).

## Analysis
Generate some example data according to setting above

```{r}
logit <- function(p)
  log(p/(1-p))
inv_logit <- function(y)
  1/(1+exp(-y))
doseV <- rep(doses, each = 30)
N <- length(doseV)
## generate covariates
x1 <- rnorm(N, 0, 1)
x2 <- factor(sample(c("A", "B"), N, replace=TRUE, prob=c(0.75, 0.25)))
## assume approximately 10% placebo and 45% asymptotic response
prob <- inv_logit(emax(doseV, -2.2, 2, 0.5) + 0.3*x1 + 0.3*(x2=="B"))
y <- rbinom(N, 1, prob)
dat <- data.table(y=y, dose=doseV, x1=x1, x2=x2)
```

## Analysis considerations (assuming no covariates)

Same as outline in Pinheiro et al 2014
Perform MCP-Mod test on logit scale (contrasts applied to logits).

```{r}
## First assume covariates had not been used in the analysis
fit <- glm(y~factor(dose)-1, data=dat, family=binomial)
S <- vcov(fit)
est <- coef(fit)
MCTtest(doses, est, S=S, models=mods, type="general")
```
Dose-response modelling proceeds as XYZ.

```{r}
nSim <- 1000
sims <- rmvnorm(nSim, est, S)
## now actual model fitting and selection of best model for all bootstraps
bnds <- defBnds(max(doses)) ## boundaries assumed for model fitting (force convergence)
dsq <- seq(0,4,length=51)
pred <- matrix(nrow=nSim, ncol=51) ## will contain dr-model predictions 
fit <- vector("list", 3)
for(i in 1:nSim){
  fit[[1]] <- fitMod(doses, sims[i,], model="emax", S=S,
                     type="general", bnds=bnds$emax)
  fit[[2]] <- fitMod(doses, sims[i,], model="sigEmax", S=S,
                     type="general", bnds=bnds$sigEmax)
  fit[[3]] <- fitMod(doses, sims[i,], model="betaMod", S=S,
                     type="general", bnds=bnds$betaMod)
  ind <- which.min(sapply(fit, gAIC)) ## choose best model according to AIC
  pred[i,] <- predict(fit[[ind]], doseSeq=dsq, predType="ls-means")
}
qq <- apply(pred, 2, function(x) quantile(x, c(0.025,0.25,0.5,0.75,0.975)))
pp <- inv_logit(qq)

pdat <- data.table(dsq = dsq, pred = pp[3,],
                   low1 = pp[2,], high1 = pp[4,],
                   low2 = pp[1,], high2 = pp[5,])
qq <- qnorm(0.975)
pdat2 <- data.table(dose = doses, est=inv_logit(est),
                    LB = inv_logit(est - qq*sqrt(diag(S))),
                    UB = inv_logit(est + qq*sqrt(diag(S))))

qplot(dsq, pred, data=pdat, geom="line", xlab = "Dose",
      ylab="Response Probability")+
  geom_point(aes(dose, y=est), data=pdat2, alpha=0.5)+
  geom_errorbar(aes(x=dose, y=est, ymin = LB, ymax = UB),
                 data=pdat2, width=0,alpha=0.5)+
  geom_ribbon(aes(ymin = low1, ymax = high1), alpha=0.2)+
  geom_ribbon(aes(ymin = low2, ymax = high2), alpha=0.2)+
  scale_y_continuous(breaks = seq(0,1,by=0.05))+
  theme_bw()
```

## Analysis considerations (assuming there are covariates)

```{r}
fit <- glm(y~factor(dose)+x1+x2, data=dat, family=binomial)
## predict every patient under every dose
pdat <- data.table(dose = rep(doses, each = nrow(dat)),
                   x1 = rep(x1, length(doses)),
                   x2 = rep(x2, length(doses)))
get_pred <- function(X, par, doses){
  p <- inv_logit(X%*%par)
  logit(tapply(p, doses, mean))
}
X <- model.matrix(~factor(dose)+x1+x2, data=pdat)
est <- get_pred(X, coef(fit), pdat$dose)
## now calculate variance estimate
sims <- rmvnorm(1000, coef(fit), vcov(fit))
preds <- matrix(nrow=1000, ncol=length(doses))
for(i in 1:1000){
  preds[i,] <- get_pred(X, sims[i,], pdat$dose)
}
S <- cov(preds)

## perform multiple contrast test
MCTtest(doses, est, S=S, type = "general", models=mods)
```

Dose-response modelling proceeds in the same way as before (for
completeness reproduced here).

```{r}
nSim <- 1000
sims <- rmvnorm(nSim, est, S)
## now actual model fitting and selection of best model for all bootstraps
bnds <- defBnds(max(doses)) ## boundaries assumed for model fitting (force convergence)
dsq <- seq(0,4,length=51)
pred <- matrix(nrow=nSim, ncol=51) ## will contain dr-model predictions 
fit <- vector("list", 3)
for(i in 1:nSim){
  fit[[1]] <- fitMod(doses, sims[i,], model="emax", S=S,
                     type="general", bnds=bnds$emax)
  fit[[2]] <- fitMod(doses, sims[i,], model="sigEmax", S=S,
                     type="general", bnds=bnds$sigEmax)
  fit[[3]] <- fitMod(doses, sims[i,], model="betaMod", S=S,
                     type="general", bnds=bnds$betaMod)
  ind <- which.min(sapply(fit, gAIC)) ## choose best model according to AIC
  pred[i,] <- predict(fit[[ind]], doseSeq=dsq, predType="ls-means")
}
qq <- apply(pred, 2, function(x) quantile(x, c(0.025,0.25,0.5,0.75,0.975)))
pp <- inv_logit(qq)

pdat <- data.table(dsq = dsq, pred = pp[3,],
                   low1 = pp[2,], high1 = pp[4,],
                   low2 = pp[1,], high2 = pp[5,])
qq <- qnorm(0.975)
pdat2 <- data.table(dose = doses, est=inv_logit(est),
                    LB = inv_logit(est - qq*sqrt(diag(S))),
                    UB = inv_logit(est + qq*sqrt(diag(S))))

qplot(dsq, pred, data=pdat, geom="line", xlab = "Dose",
      ylab="Response Probability")+
  geom_point(aes(dose, y=est), data=pdat2, alpha=0.5)+
  geom_errorbar(aes(x=dose, y=est, ymin = LB, ymax = UB),
                 data=pdat2, width=0,alpha=0.5)+
  geom_ribbon(aes(ymin = low1, ymax = high1), alpha=0.2)+
  geom_ribbon(aes(ymin = low2, ymax = high2), alpha=0.2)+
  scale_y_continuous(breaks = seq(0,1,by=0.05))+
  theme_bw()
```


## Re-calculation of optimal contrasts

Show some simulation results here (from presentation)
