---
title: "Analysis template MCP-Mod for continuous data"
output: rmarkdown::html_vignette
bibliography: refs.bib
csl: american-statistical-association.csl
link-citations: yes
vignette: >
  %\VignetteIndexEntry{Analysis template MCP-Mod for continuous data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
library(data.table)
library(ggplot2)
knitr::opts_chunk$set(echo = TRUE, message = FALSE, cache = TRUE,
                      comment = NA,
                      dev = "png", dpi = 150, fig.asp = 0.618, fig.width = 7, out.width = "85%", fig.align = "center")
theme_set(theme_bw())
```

## Background and Data

In this vignette we will illustrate the usage of the DoseFinding package for analyzing continuously distributed data.
In order not to complicate matters unnecessarily,
we will focus on the planning and analysis stages for a parallel group design.
There is a separate vignette with details on [sample size and power calculation](3_sample_size.html).

We will use data from @verkindre2010,
who actually use a cross-over design and utilize MCP-Mod only in a supportive analysis.
More information can be found at the corresponding
[clinicaltrials.gov page](https://clinicaltrials.gov/ct2/show/NCT00501852)
and on the R help page `?glycobrom`.

The main purpose @verkindre2010 was to provide safety and efficacy data on Glycopyrronium Bromide (NVA237)
in patients with stable Chronic Obstructive Pulmonary Disease ([COPD](https://en.wikipedia.org/wiki/Chronic_obstructive_pulmonary_disease)).
The primary endpoint in this study was the mean of two measurements of forced expiratory volume in 1 second
([FEV1](https://en.wikipedia.org/wiki/FEV1#Forced_expiratory_volume_in_1_second_(FEV1)))
at 23h 15min and 23h 45min post dosing,
following 7 days of treatment.

In order to keep this exposition simple,
we will ignore the active control
and focus on the placebo group and the four dose groups (12.5, 25, 50, and 100μg).

As the article is open access,
but the raw measurements are not available,
we recreate a dataset from the published summary statistics.
These can be found in the `glycobrom` dataset coming with the `DoseFinding` package.
Here `fev1` and `sdev` contain the mean and standard _error_ (not standard deviation, despite the name) of the primary endpoint for each group,
while `n` denotes the number of participants.

```{r, load_data}
library(DoseFinding)
data(glycobrom)
print(glycobrom)
```

We want to create a dataset with 60 participants in each of the five groups.
Noticing that the standard errors are essentially equal across all groups,
we draw five vectors of measurement errors centered at `0` with identical variances `60 * 0.015^2`
which we add to the observed means.

Note that here we use `MASS::mvrnorm` instead of `rnorm`
because it lets us generate random numbers with the specified _sample_ mean and sd.

```{r, simulate_dataset}
set.seed(1)
sigma <- sqrt(0.015^2*60)
rand <- rep(MASS::mvrnorm(60, 0, 60 * 0.015^2, empirical = TRUE), 5)
NVA <- data.frame(dose = rep(glycobrom$dose, each = 60),
                  FEV1 = rep(glycobrom$fev1, each = 60) + rand)
ggplot(NVA) + geom_jitter(aes(dose, FEV1), height = 0, width = 4) +
  labs(title = "Simulated FEV1 by dose (jittered horizontally)") +
  xlab("dose [μg]") + ylab("FEV1 [l]")
```

## Design stage

Now let's forget we already saw the data
and imagine we had to design this trial with MCP-Mod.

First we decide that we want to include two Emax models,
one sigmoid Emax model
and one quadratic model in the analysis
(see `?drmodels` for other choices).
While the (sigmoid) Emax type covers monotonic dose-response-relationships,
the quadratic model is there to accommodate a potentially decreasing effect at high doses.

Next we have to supply guesstimates for the nonlinear parameters:

- ED50 for an Emax model
- ED50 and the hill parameter h for a sigmoid emax model
- coefficient ratio $\delta = \beta_2/\lvert\beta_1\rvert$ in the quadratic model $f(d, \theta) = E_0 + \beta_1 d + \beta_2 d^2$

The following choices cover a range of plausible relationships:

- ED50 = 2.6 and ED25 = 12.5 for the Emax models (all doses have substantive effects)
- ED50 = 30.5 and h = 3.5 for the sigEmax model (first dose has a negligible effect)
- delta = -0.00776 for the quadratic model (downturn for the fourth dose)

We also fix the effect of placebo at an FEV1 of `1.25` liters
and the maximum effect at `0.15` liters above placebo.
This implicitly sets the common linear parameters of all the models.

Note the syntax of the arguments to the `Mods` function:
`emax = c(2.6, 12.5)` specifies *two* Emax models,
but `sigEmax = c(30.5, 3.5)` only specifies *one* Sigmoid Emax model.

```{r, models}
doses <- c(0, 12.5, 25, 50, 100)
mods <- Mods(emax = c(2.6, 12.5), sigEmax = c(30.5, 3.5), quadratic = -0.00776,
             placEff = 1.25, maxEff = 0.15, doses = doses)
```

It's always a good idea to perform a visual sanity check of the functional relationships implied by the guesstimates.

```{r, plot_models}
plot(mods, ylab = "FEV1", layout = c(4, 1))
```

This concludes the design phase.

We can also take a look at the calculated optimal contrasts.
They have maximum power to detect a non-flat effect profile in a hypothetical world where the guesstimates are actually the true values.

```{r, contrasts}
optC <- optContr(mods, w=1)
print(optC)
plot(optC)
```

## Analysis stage

Now fast-forward to the time when we have collected the data.

### Multiple comparisons
We run the multiple contrast test with the pre-specified models.
Note that the `type` parameter defaults to `type="normal"`,
which means that we assume a homoscedastic ANOVA model for `FEV1`,
i.e. critical values are taken from a multivariate t distribution.
Further note that the first two arguments `dose` and `FEV1` are _not evaluated_,
but symbolically refer to the columns in `data=NVA`.
```{r}
MMtest <- MCTtest(dose, FEV1, models=mods, data=NVA)
print(MMtest)
```

The test results suggest a clear dose-response trend.

<!--  TODO
Now repeat testing based on generalized MCP-Mod (in practice it may
often be based on an MMRM model, see below for code).
 -->

## Dose-response estimation

In the simplest case we would now proceed to fit only a single model type,
for example the one with the largest t-statistic:
```{r, fit_single}
fit_single <- fitMod(dose, FEV1, NVA, model = "emax")
plot(fit_single)
```

But actually we want to use a more robust approach that combines bootstrapping with model averaging in the generalized MCP-Mod framework.

First we draw bootstrap samples from the multivariate normal distribution of the estimates originating from the first-stage model (ANOVA, MMRM, logistic regression, …).
Next, for each bootstrapped data set we fit our candidate models,
select the one with lowest AIC
and save the corresponding quantities of interest.
This selection step implies that the bootstrap samples potentially come from different models.
Finally we use these bootstrapped estimates for inference.
For example, we can estimate a dose-response curve by averaging over the bootstrapped means at each dose.
Similarly we can derive credible intervals based on bootstrap quantiles.
Inference for other quantities of interest can be derived in an analogous way.

As different models contribute to the bootstrap resamples,
the approach can be considered more robust than simple model selection
[see also @schorning2016 for the result of extensive simulations on this topic].
Note that contrary to the MCP step, here all model parameters are estimated.

Now let's apply this general idea to the case at hand.
Our first-stage model is an ANOVA,
and we're interested in an estimate of the dose-response curve plus confidence intervals.
Our set of candidate model types consists of Emax, sigEmax and quadratic.

We us R's builtin `lm()` function to fit an ANOVA model without intercept
and extract estimates for the model coefficients and their covariance matrix.

```{r, fit_lm}
fitlm <- lm(FEV1~factor(dose) - 1, data = NVA)
mu_hat <- coef(fitlm)
S_hat <- vcov(fitlm)
```

In the following function we simulate a vector of response values,
fit our set of candidate models
(generalized MCP-Mod is indicated by supplying `type = "general"`)
and select the one with lowest AIC.
From the selected model we predict the mean response at the doses supplied in the `dsq` argument.

Note that for technical reasons we have to supply boundaries to the fitting algorithm via the `bnds` argument to `fitMod`
(see `?fitMod` and `?defBnds` for details)

```{r, bootstrap_draw}
one_bootstrap_prediction <- function(mu_hat, S_hat, doses, bounds, dsq) {
  sim <- drop(rmvnorm(1, mu_hat, S_hat))
  fit <- lapply(c("emax", "sigEmax", "quadratic"), function(mod)
    fitMod(doses, sim, model = mod, S = S_hat, type = "general", bnds = bounds[[mod]]))
  index <- which.min(sapply(fit, gAIC))
  pred <- predict(fit[[index]], doseSeq = dsq, predType = "ls-means")
  return(pred)
}
```

Now we need a function to calculate means and quantiles on a bootstrap sample.

```{r, bootstrap_summarize}
# bs_predictions is a doses x replications matrix
summarize_predictions <- function(bs_predictions, probs) {
  stopifnot(length(probs) == 4)
  means <- rowMeans(bs_predictions)
  quants <- apply(bs_predictions, 1, quantile, probs = probs)
  bs_df <- as.data.frame(cbind(means, t(quants)))
  names(bs_df) <- c("mean", "low_out", "low_in", "high_in", "high_out")
  return(bs_df)
}
```

Finally we plot the bootstrap predictions together with point estimates and confidence intervals from the first-stage ANOVA fit.

```{r, bootstrap_plot}
dsq <- 0:100
bs_rep <- replicate(1000, one_bootstrap_prediction(mu_hat, S_hat, doses, defBnds(max(doses)), dsq))
bs_summary <- summarize_predictions(bs_rep, c(0.025, 0.25, 0.75, 0.975))
ci_half_width <- qt(0.975, fitlm$df.residual) * sqrt(diag(S_hat))
lm_summary <- data.frame(dose = doses, mu_hat = mu_hat,
                         low = mu_hat - ci_half_width, high = mu_hat + ci_half_width)

ggplot(cbind(bs_summary, dsq = dsq)) + geom_line(aes(dsq, mean)) +
  geom_ribbon(aes(x = dsq, ymin = low_in, ymax = high_in), alpha = 0.2) +
  geom_ribbon(aes(x = dsq, ymin = low_out, ymax = high_out), alpha = 0.2) +
  geom_point(aes(dose, mu_hat), lm_summary, alpha = 0.5) +
  geom_errorbar(aes(dose, ymin = low, ymax = high), lm_summary, width = 0, alpha = 0.5) +
  scale_y_continuous(breaks = seq(1.2,1.45,by=0.02)) +
  xlab("Dose") + ylab("FEV1") +
  labs(title = "ANOVA and bootstrap estimates for mean FEV1",
       subtitle = "confidence levels 50% and 95%")
```

## References
